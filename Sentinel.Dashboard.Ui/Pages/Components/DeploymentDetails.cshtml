<template id="deployment-details">
  <div class="self-center hover:bg-gray-100 w-64 items-center text-sm">
    <div v-if="deployment.alerts.length > 0" class="font-bold pb-2">
      Alerts:
      <div v-for="a in getDistinctAlerts(deployment.alerts)" class="text-red-600 truncate">{{ a }}</div>
    </div>
    <div v-if="!deployment.metrics" class="text-orange-500 font-bold pb-2">
      No data from metrics endpoint! Is the app running?
    </div>
    <div>
      Deployed <span class="font-bold">{{ toRelative(deployment.instance.metric.aks_deployed) }}</span>
    </div>
    <div class="flex">
      <div>User:</div>
      <div class="ps-1 font-bold" v-if="deployment.instance.metric.org_user"> {{ deployment.instance.metric.github_user}} ({{ deployment.instance.metric.org_user?.replace('-at-dsb.dk', '') }}) </div>
      <div class="ps-1 font-bold" v-else> {{ deployment.instance.metric.github_user}}</div>
    </div>
    <div class="flex" v-if="deployment.instance.metric.org_system && deployment.instance.metric.org_system != 'none'">
      <div>System Id:</div>
      <div class="ps-1 font-bold">{{ deployment.instance.metric.org_system }}</div>
    </div>
    <div class="flex" v-if="deployment.instance.metric.org_team && deployment.instance.metric.org_team != 'none'">
      <div>Team:</div>
      <div class="ps-1 font-bold">{{ deployment.instance.metric.org_team }}</div>
    </div>
    <div class="flex" v-if="deployment.instance.metric.org_responsible && deployment.instance.metric.org_responsible != 'none'">
      <div>Responsible:</div>
      <div class="ps-1 font-bold">{{ deployment.instance.metric.org_responsible?.replace('-at-', '@@') }}</div>
    </div>
    <div class="flex" v-if="deployment.instance.metric.org_contact && deployment.instance.metric.org_contact != 'none'">
      <div>Contact:</div>
      <div class="ps-1 font-bold">{{ deployment.instance.metric.org_contact?.replace('-at-', '@@') }}</div>
    </div>
    <div class="flex">
      <div>Branch:</div>
      <div class="ps-1 font-bold w-52 truncate">{{ deployment.instance.metric.github_branch }}</div>
    </div>
    <div class="flex">
      <div>Version:</div>
      <div class="ps-1 font-bold">{{ deployment.instance.metric.aks_version }}</div>
    </div>
    <div class="flex">
      <div>Metrics:</div>
      <div class="ps-1 font-bold">{{ deployment.metrics ? 'Yes' : 'No' }}</div>
    </div>
    <div class="flex">
      <div>NS:</div>
      <div class="ps-1 font-bold">{{ deployment.instance.metric?.namespace?.split('-')[0] }}</div>
    </div>
  </div>
</template>

<script type="module">
let setup = () => {
  let toRelative = (value) => {
    const past = luxon.DateTime.fromSeconds(Number(value)).setLocale('da-dk');
    return past.toRelativeCalendar({locale: "en"});
  }
  
  let getDistinctAlerts = (value) => {
    let alerts = value.map(x => x.metric?.alertname);
    let result = [... new Set(alerts)];
    return result;
  }
  
  return { toRelative, getDistinctAlerts }
}

components["deployment-details"] = { template: "#deployment-details", props: ['deployment'], setup};
</script>
